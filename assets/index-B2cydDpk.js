(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();class b{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}clear(){this.ctx.fillStyle="#8bc34a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawText(t,n,e,s=20,i="white"){this.ctx.fillStyle=i,this.ctx.font=`${s}px "Outfit", sans-serif`,this.ctx.fillText(t,n,e)}drawLayer(t,n,e){t.drawLayer(this.ctx,e),n.forEach(s=>{Math.round(s.z)===e&&s.draw(this.ctx)})}}class C{constructor(){this.keys={ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1,w:!1,a:!1,s:!1,d:!1,q:!1," ":!1},this.pressed={};const t={KeyW:"w",KeyA:"a",KeyS:"s",KeyD:"d",KeyQ:"q",Space:" ",ArrowUp:"ArrowUp",ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowRight:"ArrowRight"};window.addEventListener("keydown",n=>{const e=t[n.code];let s=null;e&&this.keys.hasOwnProperty(e)?s=e:this.keys.hasOwnProperty(n.key)&&(s=n.key),s&&(this.keys[s]||(this.pressed[s]=!0),this.keys[s]=!0)}),window.addEventListener("keyup",n=>{const e=t[n.code];e&&this.keys.hasOwnProperty(e)?this.keys[e]=!1:this.keys.hasOwnProperty(n.key)&&(this.keys[n.key]=!1)})}isDown(t){return this.keys[t]}isPressed(t){return this.pressed[t]}update(){this.pressed={}}get axis(){const t=(this.keys.ArrowRight||this.keys.d?1:0)-(this.keys.ArrowLeft||this.keys.a?1:0),n=(this.keys.ArrowDown||this.keys.s?1:0)-(this.keys.ArrowUp||this.keys.w?1:0);return{x:t,y:n}}}class L{constructor(){this.laneWidth=40,this.laneCount=4,this.roadWidth=this.laneWidth*this.laneCount,this.color="#555",this.lineColor="#fff",this.borderColor="#c0392b",this.waypoints=[{x:100,y:500,z:0},{x:400,y:600,z:0},{x:700,y:500,z:0},{x:900,y:300,z:0},{x:700,y:100,z:0},{x:400,y:200,z:0},{x:100,y:100,z:0},{x:-100,y:300,z:0}],this.segments=[],this.totalLength=0,this.buildSplineTrack()}buildSplineTrack(){const t=this.waypoints,n=40;this.segments=[],this.totalLength=0;const e=[t[t.length-1],...t,t[0],t[1]];for(let s=1;s<e.length-2;s++){const i=e[s-1],r=e[s],a=e[s+1],h=e[s+2];for(let o=0;o<1;o+=1/n){const l=this.catmullRom(i,r,a,h,o),c=o+1/n,d=this.catmullRom(i,r,a,h,c),f=d.x-l.x,y=d.y-l.y,u=Math.sqrt(f*f+y*y),P=r.z+(a.z-r.z)*o,T=Math.round(P);this.segments.push({p1:l,p2:d,length:u,startDist:this.totalLength,z:T,normal:{x:-y/u,y:f/u}}),this.totalLength+=u}}for(let s=0;s<this.segments.length;s++){const i=this.segments[s],r=this.segments[(s-1+this.segments.length)%this.segments.length],a=this.segments[(s+1)%this.segments.length];let h=r.normal.x+i.normal.x,o=r.normal.y+i.normal.y;const l=Math.hypot(h,o);i.n1={x:h/l,y:o/l};let c=i.normal.x+a.normal.x,d=i.normal.y+a.normal.y;const f=Math.hypot(c,d);i.n2={x:c/f,y:d/f}}}catmullRom(t,n,e,s,i){const r=i*i,a=r*i,h=.5*(2*n.x+(-t.x+e.x)*i+(2*t.x-5*n.x+4*e.x-s.x)*r+(-t.x+3*n.x-3*e.x+s.x)*a),o=.5*(2*n.y+(-t.y+e.y)*i+(2*t.y-5*n.y+4*e.y-s.y)*r+(-t.y+3*n.y-3*e.y+s.y)*a);return{x:h,y:o}}getLanePosition(t,n){t=t%this.totalLength,t<0&&(t+=this.totalLength);const e=this.segments.find(y=>t>=y.startDist&&t<y.startDist+y.length)||this.segments[this.segments.length-1],i=(t-e.startDist)/e.length,r=e.p1.x+(e.p2.x-e.p1.x)*i,a=e.p1.y+(e.p2.y-e.p1.y)*i,h=e.n1.x+(e.n2.x-e.n1.x)*i,o=e.n1.y+(e.n2.y-e.n1.y)*i,l=Math.hypot(h,o),c=h/l,d=o/l,f=(n-(this.laneCount-1)/2)*this.laneWidth;return{x:r+c*f,y:a+d*f,z:e.z,angle:Math.atan2(-c,d)}}draw(t){}drawLayer(t,n){t.lineWidth=this.roadWidth+4,t.strokeStyle=this.borderColor,t.lineCap="round",t.lineJoin="round";let e=!1;t.beginPath();for(let s=0;s<this.segments.length;s++){const i=this.segments[s];i.z===n?(e||(t.moveTo(i.p1.x,i.p1.y),e=!0),t.lineTo(i.p2.x,i.p2.y)):e&&(t.stroke(),t.beginPath(),e=!1)}e&&t.stroke(),t.lineWidth=this.roadWidth,t.strokeStyle=this.color,e=!1,t.beginPath();for(let s=0;s<this.segments.length;s++){const i=this.segments[s];i.z===n?(e||(t.moveTo(i.p1.x,i.p1.y),e=!0),t.lineTo(i.p2.x,i.p2.y)):e&&(t.stroke(),t.beginPath(),e=!1)}e&&t.stroke(),t.lineWidth=2,t.strokeStyle=this.lineColor,t.setLineDash([20,20]);for(let s=1;s<this.laneCount;s++){const i=(s-(this.laneCount-1)/2)*this.laneWidth;e=!1,t.beginPath();for(let r=0;r<this.segments.length;r++){const a=this.segments[r];if(a.z===n){const h=a.n1.x*i,o=a.n1.y*i,l=a.n2.x*i,c=a.n2.y*i;e||(t.moveTo(a.p1.x+h,a.p1.y+o),e=!0),t.lineTo(a.p2.x+l,a.p2.y+c)}else e&&(t.stroke(),t.beginPath(),e=!1)}e&&t.stroke()}t.setLineDash([])}}class g{constructor(t,n,e="sedan"){this.track=t,this.lane=n,this.targetLane=n,this.laneChangeProgress=0,this.distance=0,this.speed=0,this.targetSpeed=0,this.maxSpeed=200,this.isPlayer=!1,this.style=e,this.color=this.getColor(e),this.x=0,this.y=0,this.angle=0,this.z=0}getColor(t){switch(t){case"racecar":return"#e74c3c";case"truck":return"#3498db";case"monster":return"#9b59b6";default:return"#f1c40f"}}update(t){if(this.isPlayer||(this.speed<this.targetSpeed?this.speed+=50*t:this.speed>this.targetSpeed&&(this.speed-=100*t)),this.distance+=this.speed*t,this.lane!==this.targetLane){Math.sign(this.targetLane-this.lane);const s=2;this.laneChangeProgress+=s*t,this.laneChangeProgress>=1&&(this.lane=this.targetLane,this.laneChangeProgress=0)}let n=this.lane;this.lane!==this.targetLane&&(n=this.lane+(this.targetLane-this.lane)*this.laneChangeProgress);const e=this.track.getLanePosition(this.distance,n);this.x=e.x,this.y=e.y,this.angle=e.angle,this.z=e.z}changeLane(t){if(this.laneChangeProgress>0)return;const n=this.targetLane+t;n>=0&&n<this.track.laneCount&&(this.targetLane=n)}draw(t){switch(t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.fillStyle=this.color,t.shadowColor="rgba(0,0,0,0.3)",t.shadowBlur=5,t.shadowOffsetY=5,this.style){case"racecar":t.beginPath(),t.moveTo(15,0),t.lineTo(-15,-10),t.lineTo(-15,10),t.fill();break;case"truck":t.fillRect(-15,-12,30,24),t.fillStyle="#bdc3c7",t.fillRect(5,-10,10,20);break;case"monster":t.fillStyle="#333",t.fillRect(-12,-18,10,8),t.fillRect(-12,10,10,8),t.fillRect(2,-18,10,8),t.fillRect(2,10,10,8),t.fillStyle=this.color,t.fillRect(-15,-10,30,20);break;default:t.fillRect(-15,-10,30,20),t.fillStyle="#add8e6",t.fillRect(0,-8,5,16);break}t.restore()}}class w{constructor(t){this.track=t,this.distance=Math.random()*t.totalLength,this.offset=(Math.random()-.5)*t.roadWidth,this.walkSpeed=10+Math.random()*20,this.direction=Math.random()>.5?1:-1,this.z=0,this.active=!0,this.updatePosition()}update(t){this.active&&(this.offset+=this.walkSpeed*this.direction*t,(this.offset>this.track.roadWidth/2||this.offset<-this.track.roadWidth/2)&&(this.direction*=-1),this.updatePosition())}updatePosition(){const n=(this.track.laneCount-1)/2+this.offset/this.track.laneWidth,e=this.track.getLanePosition(this.distance,n);this.x=e.x,this.y=e.y,this.z=e.z,this.angle=e.angle}draw(t){if(!this.active)return;t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.fillStyle="#2c3e50",t.beginPath(),t.arc(0,0,5,0,Math.PI*2),t.fill(),t.strokeStyle="#2c3e50",t.lineWidth=1;const n=Date.now()/100;for(let e=0;e<4;e++){const s=e/3*Math.PI,i=8+Math.sin(n+e)*2;t.beginPath(),t.moveTo(0,0),t.lineTo(Math.cos(s)*i,Math.sin(s)*i),t.stroke(),t.beginPath(),t.moveTo(0,0),t.lineTo(Math.cos(-s)*i,Math.sin(-s)*i),t.stroke()}t.restore()}}class m{constructor(t){this.track=t,this.distance=Math.random()*t.totalLength;const n=Math.floor(Math.random()*t.laneCount);this.lane=n,this.offset=(n-(t.laneCount-1)/2)*t.laneWidth,this.active=!0,this.updatePosition()}update(t){this.updatePosition()}updatePosition(){const n=(this.track.laneCount-1)/2+this.offset/this.track.laneWidth,e=this.track.getLanePosition(this.distance,n);this.x=e.x,this.y=e.y,this.z=e.z}draw(t){if(!this.active)return;t.save(),t.translate(this.x,this.y),t.fillStyle="#f39c12",t.beginPath();const n=8;for(let e=0;e<5;e++){const s=e*4*Math.PI/5,i=Math.cos(s)*n,r=Math.sin(s)*n;e===0?t.moveTo(i,r):t.lineTo(i,r)}t.closePath(),t.fill(),t.restore()}}class k{constructor(t,n,e){this.x=t,this.y=n,this.vx=0,this.vy=0,this.radius=10,this.playerId=e,this.color=e===1?"#e74c3c":"#9b59b6"}update(t,n){let e=0,s=0;const i=500;this.playerId===1?(n.isDown("ArrowRight")&&(e+=1),n.isDown("ArrowLeft")&&(e-=1),n.isDown("ArrowDown")&&(s+=1),n.isDown("ArrowUp")&&(s-=1)):(n.isDown("d")&&(e+=1),n.isDown("a")&&(e-=1),n.isDown("s")&&(s+=1),n.isDown("w")&&(s-=1)),this.vx+=e*i*t,this.vy+=s*i*t,this.vx*=.95,this.vy*=.95,this.x+=this.vx*t,this.y+=this.vy*t}draw(t){t.save(),t.translate(this.x,this.y),t.fillStyle=this.color,t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fill(),t.fillStyle="#fff",t.beginPath(),t.arc(-3,-2,3,0,Math.PI*2),t.arc(3,-2,3,0,Math.PI*2),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(-3,-2,1,0,Math.PI*2),t.arc(3,-2,1,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(0,2,4,0,Math.PI),t.stroke(),t.restore()}}class x{constructor(){this.ctx=new(window.AudioContext||window.webkitAudioContext),this.vol=.1}playTone(t,n,e){this.ctx.state==="suspended"&&this.ctx.resume();const s=this.ctx.createOscillator(),i=this.ctx.createGain();s.type=n,s.frequency.setValueAtTime(t,this.ctx.currentTime),i.gain.setValueAtTime(this.vol,this.ctx.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+e),s.connect(i),i.connect(this.ctx.destination),s.start(),s.stop(this.ctx.currentTime+e)}playSplat(){this.playTone(100,"sawtooth",.2);const t=this.ctx.createOscillator(),n=this.ctx.createGain();t.frequency.setValueAtTime(200,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(50,this.ctx.currentTime+.3),n.gain.setValueAtTime(this.vol,this.ctx.currentTime),n.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.3),t.connect(n),n.connect(this.ctx.destination),t.start(),t.stop(this.ctx.currentTime+.3)}playCoin(){this.playTone(800,"sine",.1),setTimeout(()=>this.playTone(1200,"sine",.2),100)}}class v{constructor(){this.renderer=new b("gameCanvas"),this.input=new C,this.track=new L,this.audio=new x,this.entities=[],this.score1=0,this.score2=0,this.player1=new g(this.track,1,"racecar"),this.player1.speed=100,this.player1.isPlayer=!0,this.player1.playerId=1,this.p1Controlled=!1,this.player2=new g(this.track,2,"monster"),this.player2.speed=100,this.player2.isPlayer=!0,this.player2.playerId=2,this.p2Controlled=!1,this.entities.push(this.player1),this.entities.push(this.player2),this.entities.push(new g(this.track,0,"truck")),this.entities.push(new g(this.track,3,"sedan")),this.entities.forEach((t,n)=>{t.distance=n*150,t.isPlayer||(t.speed=100+Math.random()*50,t.targetSpeed=t.speed)});for(let t=0;t<8;t++)this.entities.push(new w(this.track)),this.entities.push(new m(this.track));this.state="RACE",this.lastTime=0,this.ballPlayers=[],this.p1InCar=!0,this.p2InCar=!0}start(){requestAnimationFrame(t=>this.loop(t))}loop(t){const n=(t-this.lastTime)/1e3;this.lastTime=t,this.update(n),this.draw(),requestAnimationFrame(e=>this.loop(e))}update(t){if(this.input.isPressed(" "))if(this.p1InCar)this.player1.speed<50&&(this.p1InCar=!1,this.ballPlayers.push(new k(this.player1.x+30,this.player1.y,1)),this.audio.playTone(300,"sine",.2));else{const e=this.ballPlayers.findIndex(s=>s.playerId===1);if(e!==-1){const s=this.ballPlayers[e];(s.x-this.player1.x)**2+(s.y-this.player1.y)**2<1600&&(this.p1InCar=!0,this.ballPlayers.splice(e,1),this.audio.playTone(400,"square",.1))}}if(this.input.isPressed("q"))if(this.p2InCar)this.player2.speed<50&&(this.p2InCar=!1,this.ballPlayers.push(new k(this.player2.x-30,this.player2.y,2)),this.audio.playTone(300,"sine",.2));else{const e=this.ballPlayers.findIndex(s=>s.playerId===2);if(e!==-1){const s=this.ballPlayers[e];(s.x-this.player2.x)**2+(s.y-this.player2.y)**2<1600&&(this.p2InCar=!0,this.ballPlayers.splice(e,1),this.audio.playTone(400,"square",.1))}}(this.input.isDown("ArrowUp")||this.input.isDown("ArrowDown")||this.input.isDown("ArrowLeft")||this.input.isDown("ArrowRight"))&&(this.p1Controlled=!0),this.p1InCar?this.p1Controlled?(this.player1.laneChangeProgress===0&&(this.input.isDown("ArrowLeft")&&this.player1.changeLane(-1),this.input.isDown("ArrowRight")&&this.player1.changeLane(1)),this.input.isDown("ArrowUp")?this.player1.speed+=300*t:this.input.isDown("ArrowDown")&&(this.player1.speed-=300*t)):this.player1.speed=120:this.player1.speed*=.95,this.player1.speed=Math.max(0,Math.min(this.player1.speed,600)),(this.input.isDown("w")||this.input.isDown("s")||this.input.isDown("a")||this.input.isDown("d"))&&(this.p2Controlled=!0),this.p2InCar?this.p2Controlled?(this.player2.laneChangeProgress===0&&(this.input.isDown("a")&&this.player2.changeLane(-1),this.input.isDown("d")&&this.player2.changeLane(1)),this.input.isDown("w")?this.player2.speed+=300*t:this.input.isDown("s")&&(this.player2.speed-=300*t)):this.player2.speed=120:this.player2.speed*=.95,this.player2.speed=Math.max(0,Math.min(this.player2.speed,600)),this.entities.forEach(e=>{e.update&&e.update(t)});const n=this.entities.filter(e=>e instanceof g);n.forEach(e=>{let s=1/0,i=null;n.forEach(a=>{if(e===a||e.lane!==a.lane)return;a.distance-e.distance;const h=this.track.totalLength;let o=e.distance%h;o<0&&(o+=h);let l=a.distance%h;l<0&&(l+=h);let c=l-o;c<0&&(c+=h),c<s&&(s=c,i=a)}),i&&s<60&&(e.speed=Math.min(e.speed,i.speed),s<40&&(e.speed=0,e.speed=i.speed))}),this.ballPlayers.forEach(e=>e.update(t,this.input)),this.entities.forEach(e=>{if(e.isPlayer){const s=e;this.entities.forEach(i=>{if(i===s||!i.active||!(i instanceof w||i instanceof m))return;Math.abs(s.distance-i.distance),this.track.totalLength;const r=s.x-i.x,a=s.y-i.y;r*r+a*a<900&&Math.abs(s.z-i.z)<.5&&this.handleCollision(s,i)})}}),this.entities=this.entities.filter(e=>e.active!==!1),Math.random()<.02&&(Math.random()>.5?this.entities.push(new w(this.track)):this.entities.push(new m(this.track))),this.input.update()}handleCollision(t,n){n instanceof w?(t.playerId===1&&(this.score1=Math.max(0,this.score1-5)),t.playerId===2&&(this.score2=Math.max(0,this.score2-5)),t.speed*=.5,n.active=!1,this.audio.playSplat()):n instanceof m&&(t.playerId===1&&(this.score1+=10),t.playerId===2&&(this.score2+=10),n.active=!1,this.audio.playCoin())}draw(){this.renderer.clear();const t=-150,n=1100,e=50,s=650,i=n-t,r=s-e,a=this.renderer.canvas.width,h=this.renderer.canvas.height,o=50,l=(a-o*2)/i,c=(h-o*2)/r,d=Math.min(l,c),f=a/2,y=h/2;this.renderer.ctx.save(),this.renderer.ctx.translate(f,y),this.renderer.ctx.scale(d,d),this.renderer.ctx.translate(-475,-350),this.renderer.drawLayer(this.track,this.entities,0),this.renderer.drawLayer(this.track,this.entities,1),this.ballPlayers.forEach(P=>{P.draw(this.renderer.ctx)}),this.renderer.ctx.restore(),this.renderer.drawText(`FPS: ${Math.round(1e3/(this.lastTime-(performance.now()-16)))}`,10,30),this.renderer.drawText("P1 (Arrows)",10,60,20,"#e74c3c"),this.renderer.drawText(`Score: ${this.score1}`,10,85,25,"#f1c40f"),this.renderer.drawText(`Speed: ${Math.round(this.player1.speed)}`,10,110,20,"#fff");const u=a-200;this.renderer.drawText("P2 (WASD)",u,60,20,"#9b59b6"),this.renderer.drawText(`Score: ${this.score2}`,u,85,25,"#f1c40f"),this.renderer.drawText(`Speed: ${Math.round(this.player2.speed)}`,u,110,20,"#fff"),this.p1InCar||this.renderer.drawText("P1 OUT!",a/2-100,h-80,20,"#e74c3c"),this.p2InCar||this.renderer.drawText("P2 OUT!",a/2-100,h-50,20,"#9b59b6")}}const M=new v;M.start();
